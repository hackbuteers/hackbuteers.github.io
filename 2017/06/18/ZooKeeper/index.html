<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="ffffff"><title>ZooKeeper - 从懵逼到淡定 | 笔记随想</title><link rel="stylesheet" type="text/css" href="http//bdimg.share.baidu.com/static/api/css/share_style1_16.css"><link rel="stylesheet" type="text/css" href="http//v2.uyan.cc/css/style.css"><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">ZooKeeper - 从懵逼到淡定</h1><a id="logo" href="/.">笔记随想</a><p class="description">程序员上辈子都是折翼的天使</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索..."></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">ZooKeeper - 从懵逼到淡定</h1><div class="post-meta"><span class="date">Jun 18, 2017</span><span class="category"><a href="/categories/ZooKeeper/">ZooKeeper</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i> Hits</i></i></span><a href="/2017/06/18/ZooKeeper/#comments" class="comment-count"><i id="uyan_count_unit"></i>留言</a></div><div class="post-content"><p>以下描述中用<strong>zk</strong>代指<strong>ZooKeeper</strong>，源码解释均基于<strong>ZooKeeper 3.4.6</strong></p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>04.11对Pigeon使用的zk集群执行变更导致集群4分钟不可用，详细如下：</p>
<ul>
<li>Pigeon使用的zk集群原本有5个节点（myid为0~5，以下描述中使用zk0指代id为0的节点，依此类推）</li>
<li>zk0、zk1、zk2提供对外提供服务（其中，zk2为leader），zk3、zk4从未对外提供服务（服务域名中未包含）</li>
<li>4月初机柜迁移，未服务的zk3、zk4在需要迁移的机柜上，将zk3、zk4先下线了</li>
<li>从提供服务的zk0、zk1、zk2里的配置中删除已经下线的zk3、zk4，择机重启</li>
<li>计划04.11进行重启节点的变更</li>
<li>此时之前下线的zk3、zk4已经关机，无法ping通</li>
<li>2017-04-11 11:19:13重启完zk1之后，集群选举持续无法成功，导致4分钟不可用</li>
<li>直到2017-04-11 11:23:01把其余两个节点（zk0、zk2）也重启了，集群才恢复可用</li>
</ul>
<p>变更之前在线下模拟了操作流程，一切正常，对客户端影响都在数秒以内。<br>这个问题，经过数天的排查，终于找到原因并且重现了。<br><strong>05.09</strong>对<strong>Kafka</strong>依赖的<strong>zk</strong>集群下线节点<strong>变更</strong>，利用前面的经验制定了下线的步骤，表现与预期相符，至此，验证了结论。<br>转眼，已经过了一个月了，小心翼翼地分享下彼时的排查过程，当然，写得异常混乱。</p>
<h2 id="懵逼"><a href="#懵逼" class="headerlink" title="懵逼"></a>懵逼</h2><p>对于故障排查，可以按照<strong>是否有现场、是否能重现、是否有详细上下文信息</strong>等几个因素分为划分，因素里面否越多，排查难度越大。<br><strong>04.11</strong>的问题等到排查的时候，属于<strong>无现场/不能重现/有详细上下文信息</strong>，毕竟有完整的<strong>ZooKeeper</strong>的日志。</p>
<p><strong>zk1</strong>日志内容摘取部分如下：<br><figure class="highlight pf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">18</span>,<span class="number">797</span> [myid:<span class="number">1</span>] - LOOKING</div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">18</span>,<span class="number">799</span> [myid:<span class="number">1</span>] - New election. My id =  <span class="number">1</span>, proposed zxid=<span class="number">0</span>x724cd35ff</div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">18</span>,<span class="number">808</span> [myid:<span class="number">1</span>] - Notification: <span class="number">1</span> (message format version), <span class="number">0</span> (n.leader), <span class="number">0</span>x724cd3601 (n.zxid), <span class="number">0</span>x8 (n.round), LOOKING (n.<span class="keyword">state</span>), <span class="number">0</span> (n.sid), <span class="number">0</span>x7 (n.peerEpoch) LOOKING (my <span class="keyword">state</span>)</div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">18</span>,<span class="number">808</span> [myid:<span class="number">1</span>] - Have smaller server identifier, so dropping the connection: (<span class="number">2</span>, <span class="number">1</span>)</div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">18</span>,<span class="number">809</span> [myid:<span class="number">1</span>] - Notification: <span class="number">1</span> (message format version), <span class="number">1</span> (n.leader), <span class="number">0</span>x724cd35ff (n.zxid), <span class="number">0</span>x1 (n.round), LOOKING (n.<span class="keyword">state</span>), <span class="number">1</span> (n.sid), <span class="number">0</span>x7 (n.peerEpoch) LOOKING (my <span class="keyword">state</span>)</div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">18</span>,<span class="number">810</span> [myid:<span class="number">1</span>] - Notification: <span class="number">1</span> (message format version), <span class="number">0</span> (n.leader), <span class="number">0</span>x724cd3601 (n.zxid), <span class="number">0</span>x8 (n.round), LOOKING (n.<span class="keyword">state</span>), <span class="number">1</span> (n.sid), <span class="number">0</span>x7 (n.peerEpoch) LOOKING (my <span class="keyword">state</span>)</div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">18</span>,<span class="number">811</span> [myid:<span class="number">1</span>] - Notification: <span class="number">1</span> (message format version), <span class="number">0</span> (n.leader), <span class="number">0</span>x724cd3601 (n.zxid), <span class="number">0</span>x8 (n.round), LOOKING (n.<span class="keyword">state</span>), <span class="number">1</span> (n.sid), <span class="number">0</span>x7 (n.peerEpoch) LOOKING (my <span class="keyword">state</span>)</div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">18</span>,<span class="number">813</span> [myid:<span class="number">1</span>] - Have smaller server identifier, so dropping the connection: (<span class="number">2</span>, <span class="number">1</span>)</div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">19</span>,<span class="number">014</span> [myid:<span class="number">1</span>] - FOLLOWING</div><div class="line">...</div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">19</span>,<span class="number">033</span> [myid:<span class="number">1</span>] - Unexpected exception, tries=<span class="number">0</span>, connecting <span class="keyword">to</span> /zk0:<span class="number">2888</span></div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">20</span>,<span class="number">034</span> [myid:<span class="number">1</span>] - Unexpected exception, tries=<span class="number">1</span>, connecting <span class="keyword">to</span> /zk0:<span class="number">2888</span></div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">21</span>,<span class="number">035</span> [myid:<span class="number">1</span>] - Unexpected exception, tries=<span class="number">2</span>, connecting <span class="keyword">to</span> /zk0:<span class="number">2888</span></div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">22</span>,<span class="number">036</span> [myid:<span class="number">1</span>] - Unexpected exception, tries=<span class="number">3</span>, connecting <span class="keyword">to</span> /zk0:<span class="number">2888</span></div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">23</span>,<span class="number">037</span> [myid:<span class="number">1</span>] - Exception when following the leader</div><div class="line">...</div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">23</span>,<span class="number">904</span> [myid:<span class="number">1</span>] - Notification time <span class="keyword">out</span>: <span class="number">400</span></div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>看到这样的信息我是很崩溃的，完全不知道是什么意思。彼时的<strong>ZooKeeeper</strong>对于我来说，就是一个黑盒，探索原因的手段非常有限，眼看成疑案了。谷律师说过，“疑案从无”，换到排查问题也一样，有疑案，说明排查的人修为不够。<strong>彼时，唯有硬啃代码了</strong>。</p>
<h2 id="硬啃"><a href="#硬啃" class="headerlink" title="硬啃"></a>硬啃</h2><p><strong>zk1</strong>的日志里面有：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">2017<span class="selector-tag">-04-11</span> 11<span class="selector-pseudo">:19</span><span class="selector-pseudo">:19</span>,030 <span class="selector-attr">[myid:1]</span> <span class="selector-tag">-</span> <span class="selector-tag">FOLLOWING</span> <span class="selector-tag">-</span> <span class="selector-tag">LEADER</span> <span class="selector-tag">ELECTION</span> <span class="selector-tag">TOOK</span> <span class="selector-tag">-</span> 231</div></pre></td></tr></table></figure></p>
<p>按理说，这个时候，<strong>LEADER ELECTION TOOK</strong>的字样已经出现了，选举应该已经结束了。<br>但是从当时<strong>四字命令</strong>cons的结果来看，集群里面3台机器确实都处于<strong>“This ZooKeeper instance is not currently serving requests”</strong>的状态。</p>
<p>再看下<strong>zk2</strong>的日志：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">2017<span class="selector-tag">-04-11</span> 11<span class="selector-pseudo">:23</span><span class="selector-pseudo">:03</span>,922 <span class="selector-attr">[myid:2]</span> <span class="selector-tag">-</span> <span class="selector-tag">LEADING</span> <span class="selector-tag">-</span> <span class="selector-tag">LEADER</span> <span class="selector-tag">ELECTION</span> <span class="selector-tag">TOOK</span> <span class="selector-tag">-</span> 232</div></pre></td></tr></table></figure></p>
<p>一直到恢复的时候才打印了<strong>LEADER ELECTION TOOK，zk0</strong>也是差不多的时间打印这个日志的。</p>
<p>难道<strong>zk1</strong>一直都在自嗨么？再看下<strong>zk1</strong>的日志：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">2017<span class="selector-tag">-04-11</span> 11<span class="selector-pseudo">:19</span><span class="selector-pseudo">:19</span>,030 <span class="selector-attr">[myid:1]</span> <span class="selector-tag">-</span> <span class="selector-tag">FOLLOWING</span> <span class="selector-tag">-</span> <span class="selector-tag">LEADER</span> <span class="selector-tag">ELECTION</span> <span class="selector-tag">TOOK</span> <span class="selector-tag">-</span> 231</div><div class="line">2017<span class="selector-tag">-04-11</span> 11<span class="selector-pseudo">:20</span><span class="selector-pseudo">:24</span>,067 <span class="selector-attr">[myid:1]</span> <span class="selector-tag">-</span> <span class="selector-tag">FOLLOWING</span> <span class="selector-tag">-</span> <span class="selector-tag">LEADER</span> <span class="selector-tag">ELECTION</span> <span class="selector-tag">TOOK</span> <span class="selector-tag">-</span> 61028</div><div class="line">2017<span class="selector-tag">-04-11</span> 11<span class="selector-pseudo">:20</span><span class="selector-pseudo">:34</span>,079 <span class="selector-attr">[myid:1]</span> <span class="selector-tag">-</span> <span class="selector-tag">FOLLOWING</span> <span class="selector-tag">-</span> <span class="selector-tag">LEADER</span> <span class="selector-tag">ELECTION</span> <span class="selector-tag">TOOK</span> <span class="selector-tag">-</span> 6006</div><div class="line">2017<span class="selector-tag">-04-11</span> 11<span class="selector-pseudo">:20</span><span class="selector-pseudo">:44</span>,089 <span class="selector-attr">[myid:1]</span> <span class="selector-tag">-</span> <span class="selector-tag">FOLLOWING</span> <span class="selector-tag">-</span> <span class="selector-tag">LEADER</span> <span class="selector-tag">ELECTION</span> <span class="selector-tag">TOOK</span> <span class="selector-tag">-</span> 6003</div><div class="line">2017<span class="selector-tag">-04-11</span> 11<span class="selector-pseudo">:20</span><span class="selector-pseudo">:54</span>,100 <span class="selector-attr">[myid:1]</span> <span class="selector-tag">-</span> <span class="selector-tag">FOLLOWING</span> <span class="selector-tag">-</span> <span class="selector-tag">LEADER</span> <span class="selector-tag">ELECTION</span> <span class="selector-tag">TOOK</span> <span class="selector-tag">-</span> 6005</div><div class="line">2017<span class="selector-tag">-04-11</span> 11<span class="selector-pseudo">:21</span><span class="selector-pseudo">:06</span>,350 <span class="selector-attr">[myid:1]</span> <span class="selector-tag">-</span> <span class="selector-tag">FOLLOWING</span> <span class="selector-tag">-</span> <span class="selector-tag">LEADER</span> <span class="selector-tag">ELECTION</span> <span class="selector-tag">TOOK</span> <span class="selector-tag">-</span> 8245</div><div class="line">2017<span class="selector-tag">-04-11</span> 11<span class="selector-pseudo">:21</span><span class="selector-pseudo">:16</span>,361 <span class="selector-attr">[myid:1]</span> <span class="selector-tag">-</span> <span class="selector-tag">FOLLOWING</span> <span class="selector-tag">-</span> <span class="selector-tag">LEADER</span> <span class="selector-tag">ELECTION</span> <span class="selector-tag">TOOK</span> <span class="selector-tag">-</span> 6005</div><div class="line">2017<span class="selector-tag">-04-11</span> 11<span class="selector-pseudo">:21</span><span class="selector-pseudo">:26</span>,370 <span class="selector-attr">[myid:1]</span> <span class="selector-tag">-</span> <span class="selector-tag">FOLLOWING</span> <span class="selector-tag">-</span> <span class="selector-tag">LEADER</span> <span class="selector-tag">ELECTION</span> <span class="selector-tag">TOOK</span> <span class="selector-tag">-</span> 6004</div><div class="line">2017<span class="selector-tag">-04-11</span> 11<span class="selector-pseudo">:21</span><span class="selector-pseudo">:36</span>,377 <span class="selector-attr">[myid:1]</span> <span class="selector-tag">-</span> <span class="selector-tag">FOLLOWING</span> <span class="selector-tag">-</span> <span class="selector-tag">LEADER</span> <span class="selector-tag">ELECTION</span> <span class="selector-tag">TOOK</span> <span class="selector-tag">-</span> 6002</div><div class="line">2017<span class="selector-tag">-04-11</span> 11<span class="selector-pseudo">:21</span><span class="selector-pseudo">:46</span>,382 <span class="selector-attr">[myid:1]</span> <span class="selector-tag">-</span> <span class="selector-tag">FOLLOWING</span> <span class="selector-tag">-</span> <span class="selector-tag">LEADER</span> <span class="selector-tag">ELECTION</span> <span class="selector-tag">TOOK</span> <span class="selector-tag">-</span> 5999</div><div class="line">2017<span class="selector-tag">-04-11</span> 11<span class="selector-pseudo">:21</span><span class="selector-pseudo">:56</span>,388 <span class="selector-attr">[myid:1]</span> <span class="selector-tag">-</span> <span class="selector-tag">FOLLOWING</span> <span class="selector-tag">-</span> <span class="selector-tag">LEADER</span> <span class="selector-tag">ELECTION</span> <span class="selector-tag">TOOK</span> <span class="selector-tag">-</span> 6002</div><div class="line">2017<span class="selector-tag">-04-11</span> 11<span class="selector-pseudo">:22</span><span class="selector-pseudo">:06</span>,393 <span class="selector-attr">[myid:1]</span> <span class="selector-tag">-</span> <span class="selector-tag">FOLLOWING</span> <span class="selector-tag">-</span> <span class="selector-tag">LEADER</span> <span class="selector-tag">ELECTION</span> <span class="selector-tag">TOOK</span> <span class="selector-tag">-</span> 5999</div><div class="line">2017<span class="selector-tag">-04-11</span> 11<span class="selector-pseudo">:22</span><span class="selector-pseudo">:16</span>,399 <span class="selector-attr">[myid:1]</span> <span class="selector-tag">-</span> <span class="selector-tag">FOLLOWING</span> <span class="selector-tag">-</span> <span class="selector-tag">LEADER</span> <span class="selector-tag">ELECTION</span> <span class="selector-tag">TOOK</span> <span class="selector-tag">-</span> 6000</div><div class="line">2017<span class="selector-tag">-04-11</span> 11<span class="selector-pseudo">:22</span><span class="selector-pseudo">:26</span>,405 <span class="selector-attr">[myid:1]</span> <span class="selector-tag">-</span> <span class="selector-tag">FOLLOWING</span> <span class="selector-tag">-</span> <span class="selector-tag">LEADER</span> <span class="selector-tag">ELECTION</span> <span class="selector-tag">TOOK</span> <span class="selector-tag">-</span> 6002</div><div class="line">2017<span class="selector-tag">-04-11</span> 11<span class="selector-pseudo">:22</span><span class="selector-pseudo">:36</span>,411 <span class="selector-attr">[myid:1]</span> <span class="selector-tag">-</span> <span class="selector-tag">FOLLOWING</span> <span class="selector-tag">-</span> <span class="selector-tag">LEADER</span> <span class="selector-tag">ELECTION</span> <span class="selector-tag">TOOK</span> <span class="selector-tag">-</span> 6000</div><div class="line">2017<span class="selector-tag">-04-11</span> 11<span class="selector-pseudo">:22</span><span class="selector-pseudo">:46</span>,416 <span class="selector-attr">[myid:1]</span> <span class="selector-tag">-</span> <span class="selector-tag">FOLLOWING</span> <span class="selector-tag">-</span> <span class="selector-tag">LEADER</span> <span class="selector-tag">ELECTION</span> <span class="selector-tag">TOOK</span> <span class="selector-tag">-</span> 5999</div><div class="line">2017<span class="selector-tag">-04-11</span> 11<span class="selector-pseudo">:22</span><span class="selector-pseudo">:56</span>,422 <span class="selector-attr">[myid:1]</span> <span class="selector-tag">-</span> <span class="selector-tag">FOLLOWING</span> <span class="selector-tag">-</span> <span class="selector-tag">LEADER</span> <span class="selector-tag">ELECTION</span> <span class="selector-tag">TOOK</span> <span class="selector-tag">-</span> 6000</div><div class="line">2017<span class="selector-tag">-04-11</span> 11<span class="selector-pseudo">:23</span><span class="selector-pseudo">:03</span>,904 <span class="selector-attr">[myid:1]</span> <span class="selector-tag">-</span> <span class="selector-tag">FOLLOWING</span> <span class="selector-tag">-</span> <span class="selector-tag">LEADER</span> <span class="selector-tag">ELECTION</span> <span class="selector-tag">TOOK</span> <span class="selector-tag">-</span> 3476</div></pre></td></tr></table></figure></p>
<p>契而不舍地自嗨了<strong>10</strong>多次，这个其实是可以理解的，<strong>zk1</strong>认为集群里面只有3个节点，拿到两票一致，就认为选举结束了，而<strong>zk0、zk2</strong>还是认为集群里面有<strong>5</strong>个节点，所以需要<strong>3</strong>个节点的投票完全统一，才能结束选举。</p>
<p>这时候有一个问题：为什么<strong>zk1</strong>进入了<strong>FOLLOWING</strong>状态之后，会再一次进行<strong>Looking</strong>状态，重新参与选举呢？</p>
<h2 id="问题A"><a href="#问题A" class="headerlink" title="问题A"></a>问题A</h2><blockquote>
<p>为什么<strong>zk1</strong>进入了<strong>FOLLOWING</strong>状态之后，会再一次进行<strong>Looking</strong>状态，重新参与选举呢？</p>
</blockquote>
<p><strong>zk</strong>节点进行<strong>FOLLOWING</strong>状态之后会调用<strong>Follower.followLeader</strong>（代码位于<strong>src/java/main/org/apache/zookeeper/server/quorum/Follower.java</strong>），如果处于正常状态，会一直处于<strong>followLeader</strong>方法的一个<strong>loop</strong>中。</p>
<p>摘取部分代码如下：<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * the main method called by the follower to follow the leader</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @throws InterruptedException</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="literal">void</span> followLeader() throws InterruptedException &#123;</div><div class="line">    <span class="built_in">self</span>.end_fle = System.currentTimeMillis();</div><div class="line">    <span class="keyword">LOG</span>.info(<span class="string">"FOLLOWING - LEADER ELECTION TOOK - "</span> +</div><div class="line">          (<span class="built_in">self</span>.end_fle - <span class="built_in">self</span>.start_fle));</div><div class="line">    <span class="built_in">self</span>.start_fle = <span class="number">0</span>;</div><div class="line">    <span class="built_in">self</span>.end_fle = <span class="number">0</span>;</div><div class="line">    fzk.registerJMX(<span class="literal">new</span> FollowerBean(this, zk), <span class="built_in">self</span>.jmxLocalPeerBean);</div><div class="line">    try &#123;</div><div class="line">        <span class="comment">// get InetSocketAddress of current vote id</span></div><div class="line">        InetSocketAddress addr = findLeader();</div><div class="line">        try &#123;</div><div class="line">            <span class="comment">// zk1进行这个方法时，会去调用connectToLeader去连接leader</span></div><div class="line">            connectToLeader(addr);</div><div class="line">            <span class="params">...</span></div><div class="line">            <span class="comment">// 如果处于正常状态，线程会一直处于这个loop中</span></div><div class="line">            <span class="keyword">while</span> (<span class="built_in">self</span>.isRunning()) &#123;</div><div class="line">                readPacket(qp);</div><div class="line">                processPacket(qp);</div><div class="line">            &#125;</div><div class="line">        &#125; catch (IOException e) &#123;</div><div class="line">            <span class="comment">// 在我们的case中，connectToLeader抛出的异常会在这里捕获，打印日志，然后退出followLeader方法</span></div><div class="line">            <span class="keyword">LOG</span>.warn(<span class="string">"Exception when following the leader"</span>, e);</div><div class="line">            <span class="params">...</span></div><div class="line">        &#125;</div><div class="line">    &#125; finally &#123;</div><div class="line">        zk.unregisterJMX((Learner)this);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如上面代码中的中文注释所示，<strong>zk1</strong>会去调用<strong>connectToLeader</strong>，那么连接<strong>leader</strong>的哪个端口呢？<br>我们回头看一下配置文件<strong>conf/zoo.cfg</strong>的内容：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">..</span>.</div><div class="line"><span class="attribute">clientPort</span>=2181</div><div class="line"><span class="built_in">..</span>.</div><div class="line">server.<span class="attribute">0</span>=zk0:2888:3888</div><div class="line">server.<span class="attribute">1</span>=zk1:2888:3888</div><div class="line">server.<span class="attribute">2</span>=zk2:2888:3888</div><div class="line">server.<span class="attribute">3</span>=zk3:2888:3888</div><div class="line">server.<span class="attribute">4</span>=zk4:2888:3888</div><div class="line"><span class="built_in">..</span>.</div></pre></td></tr></table></figure></p>
<p>一共存在<strong>2181、2888、3888</strong>这3个端口。</p>
<ul>
<li><strong>2181</strong>最常见，是客户端使用的、提供服务的端口</li>
<li><strong>2888</strong>是<strong>Leader</strong>的专属端口，只有<strong>Leader</strong>会启动这个端口，就像<strong>Leader</strong>的权杖一样</li>
<li><strong>3888</strong>是<strong>zk</strong>节点在选举期间进行通信的</li>
</ul>
<p>所以，<strong>connectToLeader</strong>会去连接<strong>leader</strong>（这时候从投票结果中，<strong>zk1</strong>认为<strong>zk0</strong>是<strong>leader</strong>）的<strong>2888</strong>端口，而这时，<strong>zk0</strong>并没有认为自己是<strong>leader</strong>，并没有启动<strong>2888</strong>端口，所以<strong>zk1</strong>的日志中会有如下的报错：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">2017-04-11 11:19:19,033 [myid:1] - Unexpected exception, <span class="attribute">tries</span>=0, connecting <span class="keyword">to</span> /zk0:2888</div></pre></td></tr></table></figure></p>
<p><strong>connectToLeader</strong>中会重试<strong>5</strong>次，每次重试之前间隔<strong>1s</strong>，全部重试失败之后，会抛出异常到上层，从而导致<strong>followLeader</strong>方法退出。<br>再看看<strong>QuorumPeer.run</strong>（代码位于<strong>src/java/main/org/apache/zookeeper/server/quorum/QuorumPeer.java</strong>）方法里面，节点进入<strong>FOLLOWING</strong>状态后的处理：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">case</span> <span class="selector-tag">FOLLOWING</span>:</div><div class="line">    <span class="comment">// in another word, when our state switch to FOLLOWING ..</span></div><div class="line">    <span class="selector-tag">try</span> &#123;</div><div class="line">        <span class="selector-tag">LOG</span><span class="selector-class">.info</span>(<span class="string">"FOLLOWING"</span>);</div><div class="line">        <span class="selector-tag">setFollower</span>(makeFollower(logFactory));</div><div class="line">        <span class="comment">// 我们的case中，zk1调用followLeader后会因为连接不上leader而退出</span></div><div class="line">        <span class="selector-tag">follower</span><span class="selector-class">.followLeader</span>();</div><div class="line">    &#125; <span class="selector-tag">catch</span> (Exception e) &#123;</div><div class="line">        <span class="selector-tag">LOG</span><span class="selector-class">.warn</span>(<span class="string">"Unexpected exception"</span>,e);</div><div class="line">    &#125; <span class="selector-tag">finally</span> &#123;</div><div class="line">        <span class="comment">// followLeader退出之后，会进行到这里，关闭follower</span></div><div class="line">        <span class="selector-tag">follower</span><span class="selector-class">.shutdown</span>();</div><div class="line">        <span class="selector-tag">setFollower</span>(null);</div><div class="line">        <span class="comment">// 关闭掉follower之后，会重新将节点状态设置为LOOKING</span></div><div class="line">        <span class="selector-tag">setPeerState</span>(ServerState.LOOKING);</div><div class="line">    &#125;</div><div class="line">    <span class="selector-tag">break</span>;</div></pre></td></tr></table></figure></p>
<p>所以这个问题的路径是：</p>
<ul>
<li><strong>=&gt; zk1</strong>进入<strong>FOLLOWING</strong>状态</li>
<li><strong>=&gt; zk1</strong>调用<strong>followLeader</strong>去连接<strong>leader</strong></li>
<li><strong>=&gt; zk1</strong>认为的<strong>leader-zk0</strong>并不认为自己是<strong>leader</strong>，没有启动<strong>2888</strong>端口</li>
<li><strong>=&gt; zk1</strong>连接<strong>leader</strong>失败</li>
<li><strong>=&gt; zk1</strong>退出<strong>FOLLOWING</strong>状态，进入<strong>LOOKING</strong>状态</li>
</ul>
<p>这时候有一个问题：为什么<strong>zk0</strong>没有进入<strong>leader</strong>状态；如果是因为<strong>zk2</strong>没有投票给<strong>zk0</strong>，为什么<strong>zk2</strong>没有投票给<strong>zk0</strong>？</p>
<h2 id="问题B"><a href="#问题B" class="headerlink" title="问题B"></a>问题B</h2><blockquote>
<p>为什么<strong>zk0</strong>没有进入<strong>leader</strong>状态；如果是因为<strong>zk2</strong>没有投票给<strong>zk0</strong>，为什么<strong>zk2</strong>没有投票给<strong>zk0</strong>？</p>
</blockquote>
<p><strong>zk0</strong>没有进入<strong>leader</strong>状态说明没有获取足够的票数，从<strong>zk1</strong>的日志里面可以看到，<strong>zk1</strong>已经投票给了<strong>zk0</strong>：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">2017-04-11</span> <span class="selector-tag">11</span><span class="selector-pseudo">:19</span><span class="selector-pseudo">:18</span>,<span class="selector-tag">811</span> <span class="selector-attr">[myid:1]</span> <span class="selector-tag">-</span> <span class="selector-tag">Notification</span>: <span class="selector-tag">1</span> (message format version), <span class="selector-tag">0</span> (n.leader), <span class="selector-tag">0x724cd3601</span> (n.zxid), <span class="selector-tag">0x8</span> (n.round), <span class="selector-tag">LOOKING</span> (n.state), <span class="selector-tag">1</span> (n.sid), <span class="selector-tag">0x7</span> (n.peerEpoch) <span class="selector-tag">LOOKING</span> (my state)</div></pre></td></tr></table></figure></p>
<p>这里解释一下，<strong>zk</strong>选举过程中最关键的日志的格式。这个日志是在<strong>FastLeaderElection.printNotification</strong>（代码位于<strong>src/java/main/org/apache/zookeeper/server/quorum/FastLeaderElection.java</strong>）中打印的。逐段来看下含义：</p>
<ul>
<li><strong>1 (message format version)</strong><br>消息协议的版本号，从代码里面看，这个字段比较好的版本里面是<strong>0</strong>，<strong>ZooKeeper 3.4.6</strong>里面，这个版本号是<strong>1</strong>。</li>
<li><strong>0 (n.leader)</strong><br>收到的投票里面的<strong>leader</strong>对应的<strong>id</strong>。例子里面这张投票是投给<strong>zk0</strong>的。</li>
<li><strong>0x724cd3601 (n.zxid)</strong><br>收到的投票里面的<strong>leader</strong>对应的<strong>zxid</strong>，<strong>zxid</strong>的高<strong>32</strong>位代表<strong>epoch</strong>（选出<strong>leader</strong>后会对<strong>epoch</strong>进行更新），低<strong>32</strong>位代表日志偏移。例子里面的数据说明，收到的这张投票里面。</li>
<li><strong>0x8 (n.round)</strong><br>投票发送方的<strong>logicalclock</strong>，这个值和节点进入<strong>FastLeaderElection.lookForLeader</strong>方法的次数是相关的，譬如我们的<strong>case</strong>中，<strong>zk1</strong>频繁地进行<strong>LOOKING-&gt;FOLLOWING-&gt;LOOKING</strong>状态的转换，所以<strong>logicalclock</strong>会不断地增加。如果节点收到一张投票，<strong>n.round</strong>是比自己的<strong>logicalclock</strong>大时，就会更新自己的<strong>logicalclock</strong>，更新自己的票为收到的投票信息或者初始票（初始票即为投票信息填写的是节点自己的信息）。<strong>zk1</strong>每次重新进行<strong>LOOKING</strong>状态时，<strong>logicalclock</strong>都比别的节点要大，但是<strong>zk1</strong>的<strong>zxid</strong>比其它两个节点要小，所以<strong>zk0</strong>和<strong>zk1</strong>会各自重新投票给自己。</li>
<li><strong>LOOKING (n.state)</strong><br>投票发送方的状态。例子里面发送方<strong>zk1</strong>的状态为<strong>LOOKING</strong>。</li>
<li><strong>1 (n.sid)</strong><br>投票发送方的id。例子里面这张投票是<strong>zk1</strong>发送出来的。</li>
<li><strong>0x7 (n.peerEpoch)</strong><br>收到的投票里面的<strong>leader</strong>对应的<strong>epoch</strong>，当然，这个值已经被<strong>n.zxid</strong>所涵盖了</li>
<li><strong>LOOKING (my state)</strong><br>自己的状态，即投票接收方当前的状态。</li>
</ul>
<p>解释完了日志的信息，再从<strong>zk0</strong>的日志里面去看下为什么<strong>zk0</strong>没有获得足够的票：<br><figure class="highlight pf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 这里由于zk1重启，zk0进入了LOOKING状态</span></div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">13</span>,<span class="number">037</span> [myid:<span class="number">0</span>] - LOOKING</div><div class="line">...</div><div class="line"><span class="comment"># 进行选举阶段，这时候，会把自己的信息放入选票中，投给所有的节点：zk0/zk1/zk2/zk3/zk4</span></div><div class="line"><span class="comment"># 我们把这次选票投递标记成 Proposal1</span></div><div class="line"><span class="comment"># zk1此时关闭了，还没启动起来，3888端口没有打开；zk3/zk4目前已经关机，ping不通了</span></div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">13</span>,<span class="number">662</span> [myid:<span class="number">0</span>] - New election. My id = <span class="number">0</span>, proposed zxid=<span class="number">0</span>x724cd3601</div><div class="line"><span class="comment"># 收到了自己 Proposal1阶段 的投票</span></div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">13</span>,<span class="number">663</span> [myid:<span class="number">0</span>] - Notification: <span class="number">1</span> (message format version), <span class="number">0</span> (n.leader), <span class="number">0</span>x724cd3601 (n.zxid), <span class="number">0</span>x8 (n.round), LOOKING (n.<span class="keyword">state</span>), <span class="number">0</span> (n.sid), <span class="number">0</span>x7 (n.peerEpoch) LOOKING (my <span class="keyword">state</span>)</div><div class="line"><span class="comment"># 选票发送给zk1的时候失败，因为zk1此时还没有启动</span></div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">13</span>,<span class="number">674</span> [myid:<span class="number">0</span>] - Cannot open channel <span class="keyword">to</span> <span class="number">1</span> at election address /zk1:<span class="number">3888</span></div><div class="line"><span class="comment"># 由于zk中只能由id大的节点向id小的节点建立链接，所以，zk0会把已经建立的到zk2的链接关闭掉</span></div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">13</span>,<span class="number">675</span> [myid:<span class="number">0</span>] - Have smaller server identifier, so dropping the connection: (<span class="number">2</span>, <span class="number">0</span>)</div><div class="line"><span class="comment"># 收到zk2的链接，这个是zk2也进入了选举阶段之后，向各个节点发送选票的时候，建立的链接</span></div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">13</span>,<span class="number">676</span> [myid:<span class="number">0</span>] - Received connection request /zk2:<span class="number">22864</span></div><div class="line"><span class="comment"># zk0收到zk2的两张选票，第一张选票的epoch是0x6，怀疑是上一次选举留下的</span></div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">13</span>,<span class="number">677</span> [myid:<span class="number">0</span>] - Notification: <span class="number">1</span> (message format version), <span class="number">2</span> (n.leader), <span class="number">0</span>x6002c6134 (n.zxid), <span class="number">0</span>x7 (n.round), LOOKING (n.<span class="keyword">state</span>), <span class="number">2</span> (n.sid), <span class="number">0</span>x6 (n.peerEpoch) LOOKING (my <span class="keyword">state</span>)</div><div class="line"><span class="comment"># zk0收到zk2的第二张选票，里面携带的是zk2自己的信息，zk2的epoch/zxid和zk0相同，但是id比zk0要大</span></div><div class="line"><span class="comment"># 这个时候，zk0应该修改自己的当前选票，推举zk2为leader，并把这个选票发送给所有的节点</span></div><div class="line"><span class="comment"># 我们把这次选票投递标记成 Proposal2</span></div><div class="line"><span class="comment"># 但是，从下面的日志看来，zk0迟迟没有收到自己的这张投票</span></div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">13</span>,<span class="number">730</span> [myid:<span class="number">0</span>] - Notification: <span class="number">1</span> (message format version), <span class="number">2</span> (n.leader), <span class="number">0</span>x724cd3601 (n.zxid), <span class="number">0</span>x8 (n.round), LOOKING (n.<span class="keyword">state</span>), <span class="number">2</span> (n.sid), <span class="number">0</span>x7 (n.peerEpoch) LOOKING (my <span class="keyword">state</span>)</div><div class="line"><span class="comment"># 长时间zk0没有收到任何的投票，zk0/zk2仿佛都沉默了</span></div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">13</span>,<span class="number">930</span> [myid:<span class="number">0</span>] - Notification time <span class="keyword">out</span>: <span class="number">400</span></div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">14</span>,<span class="number">331</span> [myid:<span class="number">0</span>] - Notification time <span class="keyword">out</span>: <span class="number">800</span></div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">15</span>,<span class="number">131</span> [myid:<span class="number">0</span>] - Notification time <span class="keyword">out</span>: <span class="number">1600</span></div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">16</span>,<span class="number">732</span> [myid:<span class="number">0</span>] - Notification time <span class="keyword">out</span>: <span class="number">3200</span></div><div class="line"><span class="comment"># 这个时候，还在投递 Proposal1 阶段向zk3发送投票，因为zk3此时已下线，ping不能，所以需要等待connect操作超时</span></div><div class="line"><span class="comment"># connect过程位于QuorumCnxManager.connectOne中，超时时间由zookeeper.cnxTimeout这个系统属性决定，默认5s</span></div><div class="line"><span class="comment"># 从 Proposal1 阶段开始的时间11:19:13,662到这里，刚好是5s，非常吻合</span></div><div class="line"><span class="comment"># 投票都是先发送到sendqueue里面，再由FastLeaderElection.WorkerSender取出，调用QuorumCnxManager.toSend</span></div><div class="line"><span class="comment"># QuorumCnxManager.toSend会去调用QuorumCnxManager.connectOne连接选票接收方</span></div><div class="line"><span class="comment"># 所以， Proposal1 阶段的选票还没有从sendqueue队列里面出来，是无法发送Proposal2 阶段的选票</span></div><div class="line"><span class="comment"># 令人沮丧的是，zk3/zk4都无法ping通，导致每次Proposal需要耗时10s</span></div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">18</span>,<span class="number">695</span> [myid:<span class="number">0</span>] - Cannot open channel <span class="keyword">to</span> <span class="number">3</span> at election address /zk3:<span class="number">3888</span></div><div class="line"><span class="comment"># 这个时候，zk1重启完成，发送自己的选票，连接到了zk0</span></div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">18</span>,<span class="number">803</span> [myid:<span class="number">0</span>] - Received connection request /zk1:<span class="number">4935</span></div><div class="line"><span class="comment"># 收到zk1的第一张选票，可以看到zk1的zxid比zk0/zk2是要小的</span></div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">18</span>,<span class="number">806</span> [myid:<span class="number">0</span>] - Notification: <span class="number">1</span> (message format version), <span class="number">1</span> (n.leader), <span class="number">0</span>x724cd35ff (n.zxid), <span class="number">0</span>x1 (n.round), LOOKING (n.<span class="keyword">state</span>), <span class="number">1</span> (n.sid), <span class="number">0</span>x7 (n.peerEpoch) LOOKING (my <span class="keyword">state</span>)</div><div class="line"><span class="comment"># 收到zk1的第二张选票，此时，zk1已经认为zk0是leader了</span></div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">18</span>,<span class="number">809</span> [myid:<span class="number">0</span>] - Notification: <span class="number">1</span> (message format version), <span class="number">0</span> (n.leader), <span class="number">0</span>x724cd3601 (n.zxid), <span class="number">0</span>x8 (n.round), LOOKING (n.<span class="keyword">state</span>), <span class="number">1</span> (n.sid), <span class="number">0</span>x7 (n.peerEpoch) LOOKING (my <span class="keyword">state</span>)</div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">22</span>,<span class="number">010</span> [myid:<span class="number">0</span>] - Notification time <span class="keyword">out</span>: <span class="number">6400</span></div><div class="line"><span class="comment"># 收到zk1的第三张选票，这个时候，zk1已经从FOLLOWING状态再次进入了Looking状态，又一次投票给了自己</span></div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">23</span>,<span class="number">677</span> [myid:<span class="number">0</span>] - Notification: <span class="number">1</span> (message format version), <span class="number">1</span> (n.leader), <span class="number">0</span>x724cd35ff (n.zxid), <span class="number">0</span>x9 (n.round), LOOKING (n.<span class="keyword">state</span>), <span class="number">1</span> (n.sid), <span class="number">0</span>x7 (n.peerEpoch) LOOKING (my <span class="keyword">state</span>)</div><div class="line"><span class="comment"># 这个时候，还在投递 Proposal1 阶段向zk4发送投票</span></div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">23</span>,<span class="number">701</span> [myid:<span class="number">0</span>] - Cannot open channel <span class="keyword">to</span> <span class="number">4</span> at election address /zk4:<span class="number">3888</span></div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">23</span>,<span class="number">701</span> [myid:<span class="number">0</span>] - Notification: <span class="number">1</span> (message format version), <span class="number">2</span> (n.leader), <span class="number">0</span>x724cd3601 (n.zxid), <span class="number">0</span>x8 (n.round), LOOKING (n.<span class="keyword">state</span>), <span class="number">0</span> (n.sid), <span class="number">0</span>x7 (n.peerEpoch) LOOKING (my <span class="keyword">state</span>)</div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">23</span>,<span class="number">742</span> [myid:<span class="number">0</span>] - Notification: <span class="number">1</span> (message format version), <span class="number">1</span> (n.leader), <span class="number">0</span>x724cd35ff (n.zxid), <span class="number">0</span>x9 (n.round), LOOKING (n.<span class="keyword">state</span>), <span class="number">1</span> (n.sid), <span class="number">0</span>x7 (n.peerEpoch) LOOKING (my <span class="keyword">state</span>)</div><div class="line"><span class="comment"># zk0收到zk2的第三张选票，距离上次收到zk2的投票时间，11:19:13,677，已经过去了10s</span></div><div class="line"><span class="comment"># zk2也面临着和zk0一样的问题，连接zk3/zk4的时间会耗时10s</span></div><div class="line"><span class="number">2017</span>-<span class="number">04</span>-<span class="number">11</span> <span class="number">11</span>:<span class="number">19</span>:<span class="number">23</span>,<span class="number">789</span> [myid:<span class="number">0</span>] - Notification: <span class="number">1</span> (message format version), <span class="number">2</span> (n.leader), <span class="number">0</span>x724cd3601 (n.zxid), <span class="number">0</span>x8 (n.round), LOOKING (n.<span class="keyword">state</span>), <span class="number">2</span> (n.sid), <span class="number">0</span>x7 (n.peerEpoch) LOOKING (my <span class="keyword">state</span>)</div></pre></td></tr></table></figure></p>
<p>所以<strong>问题B</strong>的答案：</p>
<ul>
<li>为什么<strong>zk0</strong>没有进入<strong>leader</strong>状态？<br>在<strong>zk1</strong>从<strong>LOOKING</strong>进入<strong>FOLLOWING</strong>的期间（<strong>11:19:18 - 11:19:19</strong>），<strong>zk0</strong>早已将自己的选票投给了<strong>zk2</strong>，<strong>zk0</strong>是不可能成为<strong>leader</strong>的。只是由于<strong>zk3/zk4</strong>的缘故，<strong>zk0</strong>的第二张选票（认为<strong>zk2</strong>是<strong>leader</strong>的投票），一直到<strong>11:19:23</strong>以后才发送给<strong>zk1</strong>，为时已晚。</li>
<li>如果是因为<strong>zk2</strong>没有投票给<strong>zk0</strong>，为什么<strong>zk2</strong>没有投票给<strong>zk0</strong><br>在<strong>zk1</strong>从<strong>LOOKING</strong>进入<strong>FOLLOWING</strong>的期间（<strong>11:19:18 - 11:19:19</strong>），<strong>zk2</strong>还卡在连接<strong>zk3/zk4</strong>上，选票无法发送出去；即使选票能发送出去，这个状态下也只可能<strong>zk2</strong>能变成<strong>leader</strong>，因为它同时拥有最大的<strong>epoch、zxid、id</strong>。</li>
</ul>
<p>所以，问题的根本原因在于，<strong>zk0/zk2</strong>变成了半哑巴，它们在集群里面说一句话，需要间隔<strong>10s</strong>，导致<strong>zk1</strong>频繁地进行状态地切换，即使它找到了正确的<strong>leader-zk2</strong>，<strong>zk2</strong>也会因为收不到<strong>zk0</strong>的选票而无法变成<strong>leader</strong>。</p>
<p>基于这个判断，使用<strong>Byteman</strong>模拟连接超时来重现故障场景。</p>
<h2 id="重现"><a href="#重现" class="headerlink" title="重现"></a>重现</h2><h3 id="版本信息"><a href="#版本信息" class="headerlink" title="版本信息"></a>版本信息</h3><p>重现过程中使用的版本如下：</p>
<ul>
<li><strong>ZooKeeper: 3.4.6</strong></li>
<li><strong>Byteman: 3.0.6</strong></li>
<li><strong>Saltstack: salt 2015.8.8 (Beryllium)</strong></li>
</ul>
<h3 id="重现步骤"><a href="#重现步骤" class="headerlink" title="重现步骤"></a>重现步骤</h3><h4 id="1-创建5节点的ZooKeeper集群"><a href="#1-创建5节点的ZooKeeper集群" class="headerlink" title="1. 创建5节点的ZooKeeper集群"></a>1. 创建<strong>5节点</strong>的<strong>ZooKeeper</strong>集群</h4><p>使用<strong>Saltstack</strong>在本地创建<strong>5节点</strong>的<strong>zk集群</strong><br><figure class="highlight pf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">salt '*' <span class="keyword">state</span>.apply zookeeper-cluster.start</div></pre></td></tr></table></figure></p>
<p>集群对应目录如下：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">tree <span class="regexp">/tmp/</span>zookeeper-cluster -L <span class="number">1</span></div><div class="line"></div><div class="line"><span class="regexp">/tmp/</span>zookeeper-cluster</div><div class="line">├── zk0</div><div class="line">├── zk1</div><div class="line">├── zk2</div><div class="line">├── zk3</div><div class="line">└── zk4</div></pre></td></tr></table></figure></p>
<p><strong>zoo.cfg</strong>中节点相关的配置如下：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">server.<span class="attribute">0</span>=localhost:8000:9000</div><div class="line">server.<span class="attribute">1</span>=localhost:8001:9001</div><div class="line">server.<span class="attribute">2</span>=localhost:8002:9002</div><div class="line">server.<span class="attribute">3</span>=localhost:8003:9003</div><div class="line">server.<span class="attribute">4</span>=localhost:8004:9004</div></pre></td></tr></table></figure></p>
<p><strong>5节点</strong>对应的<strong>clientPort</strong>为<strong>7000~7004</strong>。</p>
<p>以下描述中用<strong>zk0</strong>代指<strong>clientPort</strong>为<strong>7000</strong>的<strong>zk节点</strong>，依此类推</p>
<p>查看各个节点中集群创建完毕之后的角色<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `seq 7000 7004` <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span>: `<span class="built_in">echo</span> mntr |nc localhost <span class="variable">$i</span> |grep -E <span class="string">"zk_server_state|not currently serving"</span>`; <span class="keyword">done</span></div><div class="line"></div><div class="line">7000: zk_server_state follower</div><div class="line">7001: zk_server_state follower</div><div class="line">7002: zk_server_state leader</div><div class="line">7003: zk_server_state follower</div><div class="line">7004: zk_server_state follower</div></pre></td></tr></table></figure></p>
<h4 id="2-下线节点并修改配置"><a href="#2-下线节点并修改配置" class="headerlink" title="2. 下线节点并修改配置"></a>2. 下线节点并修改配置</h4><p>下线节点<strong>zk3/zk4</strong>：<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `seq 3 4`; <span class="keyword">do</span> <span class="keyword">cd</span> /tmp/zookeeper-<span class="keyword">cluster</span>/zk<span class="variable">$i</span>; ./bin/zkServer.<span class="keyword">sh</span> stop; <span class="keyword">cd</span> -; done</div></pre></td></tr></table></figure></p>
<p>在<strong>zk0/zk1/zk2</strong>的配置中注释掉<strong>zk3/zk4</strong>的配置：<br><figure class="highlight mel"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">`seq 0 2`</span>; <span class="keyword">do</span> gsed -i <span class="string">'s/server.\([34]\)/# server.\1/g'</span> /tmp/zookeeper-<span class="keyword">cluster</span>/zk$i/conf/zoo.cfg ; done</div></pre></td></tr></table></figure></p>
<p>注释之后的配置如下：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">server.<span class="attribute">0</span>=localhost:8000:9000</div><div class="line">server.<span class="attribute">1</span>=localhost:8001:9001</div><div class="line">server.<span class="attribute">2</span>=localhost:8002:9002</div><div class="line"><span class="comment"># server.3=localhost:8003:9003</span></div><div class="line"><span class="comment"># server.4=localhost:8004:9004</span></div></pre></td></tr></table></figure></p>
<p>这时候，各节点的角色如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `seq 7000 7004`; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span>: `<span class="built_in">echo</span> mntr |nc localhost <span class="variable">$i</span> |grep -E <span class="string">"zk_server_state|not currently serving"</span>`; <span class="keyword">done</span></div><div class="line"></div><div class="line">7000: zk_server_state follower</div><div class="line">7001: zk_server_state follower</div><div class="line">7002: zk_server_state leader</div><div class="line">7003:</div><div class="line">7004:</div></pre></td></tr></table></figure></p>
<h4 id="3-模拟连接zk3-zk4超时"><a href="#3-模拟连接zk3-zk4超时" class="headerlink" title="3. 模拟连接zk3/zk4超时"></a>3. 模拟连接<strong>zk3/zk4</strong>超时</h4><p>对<strong>zk0/zk2</strong>加载<strong>Byteman</strong>脚本，模拟连接<strong>zk3/zk4</strong>超时的问题。<br>打开监控端口<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `echo 0 2`; <span class="keyword">do</span> <span class="attribute">port</span>=1001$i; <span class="attribute">pid</span>=`cat /tmp/zookeeper-cluster/zk<span class="variable">$i</span>/data/zookeeper_server.pid`; bminstall.sh -b -Dorg.jboss.byteman.transform.all -p <span class="variable">$port</span> <span class="variable">$pid</span>; done</div></pre></td></tr></table></figure></p>
<p>加载<strong>Byteman</strong>脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `<span class="built_in">echo</span> 0 2`; <span class="keyword">do</span> port=1001<span class="variable">$i</span>; <span class="built_in">echo</span> zk<span class="variable">$i</span>; bmsubmit.sh -p <span class="variable">$port</span> Issue170411.btm; <span class="keyword">done</span></div><div class="line"></div><div class="line">zk0</div><div class="line">install rule trace pigeon.enter_connect_one_and_sleep_5s</div><div class="line"></div><div class="line">zk2</div><div class="line">install rule trace pigeon.enter_connect_one_and_sleep_5s</div></pre></td></tr></table></figure></p>
<p>脚本<strong>Issue170411.btm</strong>内容如下：<br><figure class="highlight gams"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">RULE trace pigeon.enter_connect_one_and_sleep_5s</div><div class="line">CLASS org.apache.zookeeper.server.quorum.QuorumCnxManager</div><div class="line">METHOD connectOne</div><div class="line">AT ENTRY</div><div class="line"><span class="keyword">IF</span> <span class="symbol">$</span><span class="number">1</span> &gt; <span class="number">2</span></div><div class="line">DO</div><div class="line">  traceln(<span class="string">"*** enter QuorumCnxManager.connectOne, sid: "</span> + <span class="symbol">$</span><span class="number">1</span> + <span class="string">", ts: "</span> + <span class="keyword">System</span>.currentTimeMillis() / <span class="number">1000</span> + <span class="string">" s"</span>);</div><div class="line">  Thread.<span class="built-in">sleep</span>(<span class="number">5000</span>);</div><div class="line">  traceln(<span class="string">"*** end sleep in QuorumCnxManager.connectOne, sid: "</span> + <span class="symbol">$</span><span class="number">1</span> + <span class="string">", ts: "</span> + <span class="keyword">System</span>.currentTimeMillis() / <span class="number">1000</span> + <span class="string">" s"</span>);</div><div class="line">ENDRULE</div></pre></td></tr></table></figure></p>
<h4 id="4-重启zk1"><a href="#4-重启zk1" class="headerlink" title="4. 重启zk1"></a>4. 重启<strong>zk1</strong></h4><p>重启<strong>zk1</strong>，此时<strong>zk1</strong>的配置中只有<strong>zk0/zk1/zk2</strong>这3个节点。<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">i=1; <span class="keyword">cd</span> /tmp/zookeeper-<span class="keyword">cluster</span>/zk<span class="variable">$i</span>; ./bin/zkServer.<span class="keyword">sh</span> stop; <span class="keyword">sleep</span> 5; ./bin/zkServer.<span class="keyword">sh</span> start; <span class="keyword">cd</span> -</div></pre></td></tr></table></figure></p>
<p>这时候，就可以看到选举一直无法成功，<strong>no matter how long it takes … </strong><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `seq 7000 7004`; <span class="keyword">do</span> echo <span class="variable">$i</span>: `echo mntr |nc localhost <span class="variable">$i</span> |grep -E <span class="string">"zk_server_state|not currently serving"</span>`; done</div><div class="line"></div><div class="line">7000: This ZooKeeper<span class="built_in"> instance </span>is <span class="keyword">not</span> currently serving requests</div><div class="line">7001: This ZooKeeper<span class="built_in"> instance </span>is <span class="keyword">not</span> currently serving requests</div><div class="line">7002: This ZooKeeper<span class="built_in"> instance </span>is <span class="keyword">not</span> currently serving requests</div><div class="line">7003:</div><div class="line">7004:</div></pre></td></tr></table></figure></p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>无疑，这次问题出现是因为下线操作不合理。<br><strong>zk0/zk1/zk2/zk3/zk4</strong>这样<strong>5节点</strong>的<strong>zk</strong>集群，需要下线<strong>zk3/zk4</strong>两个节点的时候，如果<strong>zk3/zk4</strong>不是原集群的<strong>leader</strong>，合理规范的操作应该是：</p>
<ul>
<li>修改<strong>zk0/zk1/zk2</strong>的配置为<strong>3节点</strong></li>
<li>逐台重启<strong>zk0/zk1/zk2</strong>，最后重启<strong>leader</strong></li>
</ul>
<p>这样，只有在重启<strong>leader</strong>时才会影响集群的可用性。</p>
<ul>
<li>上联：软柿子，越捏越不爽</li>
<li>下联：硬骨头，啃啃更健康</li>
<li>横批：迎难而上</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="http://siye1982.github.io/2015/06/16/zookeeper/" target="_blank" rel="external">http://siye1982.github.io/2015/06/16/zookeeper/</a></li>
<li><a href="https://zookeeper.apache.org/doc/trunk/zookeeperReconfig.html" target="_blank" rel="external">https://zookeeper.apache.org/doc/trunk/zookeeperReconfig.html</a></li>
<li><a href="https://zookeeper.apache.org/doc/r3.4.6/zookeeperInternals.html" target="_blank" rel="external">https://zookeeper.apache.org/doc/r3.4.6/zookeeperInternals.html</a></li>
<li><a href="https://stackoverflow.com/questions/18168541/what-is-zookeeper-port-and-its-usage" target="_blank" rel="external">https://stackoverflow.com/questions/18168541/what-is-zookeeper-port-and-its-usage</a></li>
</ul>
</div><div class="tags"><a href="/tags/ZooKeeper/">ZooKeeper</a></div><div class="post-share"><div data-thread-key="2017/06/18/ZooKeeper/" data-title="ZooKeeper - 从懵逼到淡定" data-url="https://hackbuteers.github.io/2017/06/18/ZooKeeper/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到:</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/2017/06/18/Apache-Kafka1/" class="pre">Apache_Kafka入门（一）</a><a href="/2017/06/17/ZK-session/" class="next">ZooKeeper - Session Lifetime</a></div><div id="comments"><div id="uyan_frame"></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#背景"><span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#懵逼"><span class="toc-text">懵逼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#硬啃"><span class="toc-text">硬啃</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#问题A"><span class="toc-text">问题A</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#问题B"><span class="toc-text">问题B</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#重现"><span class="toc-text">重现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#版本信息"><span class="toc-text">版本信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#重现步骤"><span class="toc-text">重现步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-创建5节点的ZooKeeper集群"><span class="toc-text">1. 创建5节点的ZooKeeper集群</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-下线节点并修改配置"><span class="toc-text">2. 下线节点并修改配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-模拟连接zk3-zk4超时"><span class="toc-text">3. 模拟连接zk3/zk4超时</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-重启zk1"><span class="toc-text">4. 重启zk1</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小结"><span class="toc-text">小结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-text">参考</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/07/16/Springboot加载自定义容器/">spring-boot加载自定义容器</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/16/spring-boot启动解读/">spring-boot启动解读</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/28/package-conflict/">JAVA - jar包冲突</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/18/Storm集群的搭建/">Storm集群的搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/18/Apache-Kafka2/">Apache_Kafka入门（二）</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/18/Apache-Kafka1/">Apache_Kafka入门（一）</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/18/ZooKeeper/">ZooKeeper - 从懵逼到淡定</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/17/ZK-session/">ZooKeeper - Session Lifetime</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/14/ZK-Data-Sync/">ZooKeeper - Data Sync</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/14/tongji/">Hexo添加百度统计流程</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/IDEA/">IDEA</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JAVA/">JAVA</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kafka/">Kafka</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Boot/">Spring Boot</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ZooKeeper/">ZooKeeper</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/Kafka/" style="font-size: 15px;">Kafka</a> <a href="/tags/ZooKeeper/" style="font-size: 15px;">ZooKeeper</a> <a href="/tags/Spring-Boot/" style="font-size: 15px;">Spring Boot</a> <a href="/tags/IDEA/" style="font-size: 15px;">IDEA</a> <a href="/tags/JAVA/" style="font-size: 15px;">JAVA</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="http://www.cnblogs.com/tengj/category/809716.html" title="hexo干货系列" target="_blank">hexo干货系列</a><ul></ul><a href="http://www.cnblogs.com/zhcncn/p/4097881.html" title="Hexo搭建Github静态博客" target="_blank">Hexo搭建Github静态博客</a><ul></ul><a href="http://blog.csdn.net/hackbuteer1" title="csdn" target="_blank">csdn</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅</a> |  <a href="/about/">关于</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">hackbuteer.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?08d029a331c2c9bec74ec1505f1df8ab";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script><script src="http://v2.uyan.cc/code/uyan.js?uid=2137468"></script></body></html>